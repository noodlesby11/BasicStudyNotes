# 数据库恢复技术与并发控制

---

## 数据库恢复技术

### 事务

事务是用户定义的一个数据库操作序列，是一个不可分割的工作单位。

####事务的ACID特性 

**原子性：**事务是数据库操作的逻辑工作单位。就操作而言，事务中的操作是一个整体，不能再被分割，要么全部成功执行，要么全部不成功执行。

**连续性：**持久性或称永久性（Permanence），是指一个事务一旦成功提交，其结果对数据库的改变将是永久的，即使是出现系统故障等问题。

**一致性：**事务的一致性是指出事务执行前后都能够保持数据库状态的一致性，即事务的执行结果是将数据库从一个一致状态转变为另一个一致状态。

**隔离性：** 隔离性是指多个事务在执行时不相互干扰的一种特性。

#### 事务的定义

```sql
begin transaction; --事务开始
commit; --以提交或者回滚结束
rollback;
```

##并发控制

### 并发控制概述

==事务是并发控制的基本单位==，事务的ACID特性遭到破坏的原因之一是事务对数据库的并发控制，为了保证事务的隔离性和一致性，就要数据库管理系统对并发操作进行正确调度。

####并发问题

**丢失修改：**两个事务T1和T2读入同一数据并修改，T2提交的结果破坏了T1提交的结果，导致T1修改被丢失。

**读“脏”数据：**简而言之，“脏”数据是指那些被某事务更改、但还没有被提交的数据。

**不可重复读：**事务T1读取某一数据后，事务T2对其进行了修改，当事务T1再次进行读取数据时，得到与之前不同的值。

**幻影读：**1. 事务T1按照某些条件从数据库中读取了某些数据记录后，事务T2删除了其中的部分记录，当T1再次读取时，某写记录神秘地消失了。2. 事务T1按照某些条件从数据库中读取了某些数据记录后，事务T2插入了一些记录，当T1再次读取时，发现多了一些记录。

### 封锁

**封锁：**是指对数据源的锁定，是SQL Server数据库引擎用来同步多个用户同时对同一个数据块进行访问的一种控制机制。基本有两种类型==排他锁（X锁）==、==共享锁（S锁）==。

**排他锁：**也称独占锁、写锁，当一个事务对一个数据块加上排他锁后，它可以对该数据块进行 UPDATE、DELETE、INSERT 等操作，而其他事务不能对该数据块加上任何锁，因而也不能执行任何的==更新==操作（包括 UPDATE、DELETE 和 INSERT）。

**共享锁：**允许多个事务并发==读取==同一数据块，但不允许其他事务==修改==当前事务加锁的数据块。一个事务对一个数据块加上一个共享锁后，其他事务也可以继续对该数据块加上共享锁。

### 封锁协议

**一级封锁协议：**事务T在修改数据R之前必须先对其加X锁，直到事务结束才释放。

**二级封锁协议：**在一级封锁协议基础上增加事务T在读取数据R之前必须先对其加S锁，读完后即可释放S锁。

**三级封锁协议：**在一级封锁协议基础上增加事务T在读取数据R之前必须先对其加S锁，直到事务结束才释放。



