# 总线系统

## 总线的概念和结构

### 总线的概念

**总线**是构成计算机系统的*互联机构，是多个系统功能部件之间进行数据传送的公共通路。借助于总线连接，计算机在各系统功能部件之间实现地址、数据和控制信息的交换，并在争用资源的基础上进行工作。

**内部总线：**CPU内部连接各寄存器及运算器部件之间的总线

**系统总线：**CPU和计算机系统中其他高速功能部件相互连接的总线

**I/O总线：**中低速I/O设备相互连接的总线

**总线带宽**：总线本身所能达到的最高传输速率，频率 * 宽度（MB/S）

### 总线连接方式

#### 单总线结构

**单总线：**使用一条单一的系统总线来连接CPU、内存和I/O设备

由于一条总线由多种功能部件共用，可能导致很大的时间延迟。

#### 多总线结构

**多总线：**在CPU、主存、I/O之间互联采用多条总线

*  高速总线通过扩充总线**接口**与扩充总线相连

* CPU总线、系统总线和高速总线通过桥彼此相连。

* 桥实质上是一种具有缓冲、转换、控制功能的逻辑电路。

### 总线的内部结构

**数据传送总线：**由地址线、数据线、控制线组成。

>地址线：单向，用来传送主存与设备的地址
>
>数据线：双向，用来传送数据
>
>控制线：对于每一根线来讲是单向的，用来指明数据传送的方向（存储器读、写或I/O读、写),中断控制和定时控制。

**仲裁总线：**包括总线请求线和总线授权线

**中断和同步总线：**用于处理带优先级的中断操作，包括中断请求线和中断认可线

**公用线：**包括时钟信号线、电源线、地线、系统复位线以及加电或断电的时序信号线等

## 总线接口

计算机的信息传输有并行传送和串行传送两种方式，出于速度和效率的考虑。系统总线上的信息必须采用并行传送的方式。

### 信息传送方式

#### 串行传送

**串行传送：**一条传输线，**脉冲**传送。 按顺序来传送一个数码所有二进制位的脉冲信号，每次一位，从低位开始传输。主要**优点：**不管传送的数据量有多少，只需要一条传输线，成本比较低廉。**缺点**就是速度慢。

#### 并行传送

**并行传送：**每一数据位需要一条传输线，一般采用**电位**传送。系统总线上传送的信息采用并行传送方式。

### 总线接口

**接口：**接口也叫适配器，是CPU、主存和外设之间通过总线进行连接的标准化逻辑部件。 起转换器的作用，以便实现彼此之间的信息传送

| 功能     | 描述                                     |
| -------- | ---------------------------------------- |
| 控制     | 控制外围设备动作，如启动、关闭设备       |
| 缓冲     | 作为一个缓冲器，补偿各种设备速度上的差异 |
| 状态     | 监视外围设备的工作状态并保存状态信息     |
| 转换     | 数据转换，如并-串转换或串-并转换         |
| 整理     | 如修改字计数器或当前内存地址寄存器       |
| 程序中断 | 发送中断请求信号给CPU                    |

==每秒钟传送的比特（bit）位数常称为波特率==

## 总线仲裁

多个功能模块争用总线，须设置总线仲裁部件，以某种方式选择其中一个设备作为总线的主方。

按照总线仲裁电路的位置不同，仲裁方式分为集中式和分布式两种

### 集中式仲裁

**有两条线连接到总线控制器**

BR：总线请求，送往仲裁器

BG：总线授权，由仲裁器发出

#### 菊花链查询方式

离中央仲裁器最近的设备具有最高优先权，离总线控制器越远，优先权越低。

链式查询方式的**主要特点**：总线授权信号BG串行地从一个接口送到下一个接口。若BG到达的接口无总线请求，则继续往下查询。 离仲裁器最近的优先级最高，BS=1表示总线正在被使用

* 优点：只用很少几根线就能按一定优先次序实现总线控制，并且这种链式结构很容易扩充设备。 

* 缺点：是对询问链的电路故障很敏感，优先级固定。

#### 计数器定时查询方式

**仲裁器中有计数器。** 接到请求信号，计数器计数，计数值通过一组地址线发向各设备。计数值与请求总线的设备地址相一致时，设备获得总线使用权，停止计数。

* 每次计数可以从0开始，也可以从中止点开始。

* 计数器的初值也可用程序来设置，方便改变优先次序。

* 以增加线数为代价。跟链式查询相比多一组设备地址线，少一根总线授权线

#### 独立请求方式

设备**各有**一对总线请求线BR~i~和总线授权线BG~i~。总线仲裁器中有**排队电路**，决定首先响应哪个设备的请求，给设备以授权信号BG~i~

* 优点：响应时间快，对优先次序控制相当灵活
* 缺点：控制线多

### 分布式仲裁

每个主方都有自己的仲裁器和仲裁号，多个仲裁器竞争使用总线。

有总线请求时，把唯一的仲裁号发送到**共享**的仲裁总线上，每个仲裁器将仲裁总线上号与自己的号进行**比较**。获胜者的仲裁号**保留**在仲裁总线上。

## 总线的定时和数据传送模式

### 总线的定时

**总线的信息传送过程（完成一次总线操作）：**请求总线—总线仲裁—寻址—信息传送—状态返回

为了协调通信双方的操作，必须要有定时协议

#### 同步总线定时协定

采用公共时钟，有统一的传输周期

* 事件出现在总线上的时刻由总线时钟信号确定

* 总线操作时序中总是包含时钟信号

* 一次I/O传送称为总线周期

* 所有事件都出现在时钟信号的前沿
* 适用于总线长度较短，各功能模块存取时间比较接近的情况

**同步写操作：**

**同步读操作：**

#### 异步总线定时协定

没有公共时钟，采用应答方式通信，允许总线上各模块的速度不一致，总线的传输周期不固定

后一事件出现的时刻取决于前一事件的出现时刻，即建立在应答式或互锁机制基础上。

* 优点：总线周期长度可变
* 缺点：增加总线的复杂性和成本

**异步写操作：**

**异步读操作：**

#### 半同步总线定时协定

整体上仍采用**同步**操作方式，采用公共时钟。增加一根**联络信号线**，如Ready，如果在给定周期内没有完成操作，可以令Ready**无效**，以增加周期

#### 周期分裂式总线定时协定

为提高总线的利用率，把每个读周期分为三步：

1. 主方通过总线向从方发送地址和读命令

2. 从方准备数据

3. 从方通过总线向主方提供数据

读周期分成两个分离的传输子周期，第一个子周期完成1，第二个子周期完成3。写周期只需要第一个子周期即可完成数据传输。

* 周期分裂式总线定时协定中，每个设备都要申请总线使

  用权。故而==读数据的双方都是总线主方==

* 周期分裂式总线定时协定以硬件复杂度的提高换取总线

  性能的提高

### 总线数据的传送模式

**读写操作：**读操作是由从方到主方的数据传送，写操作是由主方到从方的数据传送

**块传送操作：**只需给出块的起始地址，然后对固定块长度的数据一个接一个地读出或写入

**写后读、读修改写操作：**只给出地址一次（表示同一地址），或进行先写后读操作，或进行先读后写操作

**广播、广集操作：**广播是允许一个主方对多个从方进行写操作，广集与广播相反的操作，将多个从方数据在总线上完成AND或OR操作，用以检测多个中断源

